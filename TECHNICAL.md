# QuickFileCreator 技术文档

本文档详细说明 QuickFileCreator 的技术实现原理和架构设计。

---

## 目录

1. [整体架构](#整体架构)
2. [主程序 (main.py)](#主程序-mainpy)
3. [用户界面 (ui.py)](#用户界面-uipy)
4. [资源管理器路径获取 (explorer.py)](#资源管理器路径获取-explorerpy)
5. [文件创建逻辑 (file_creator.py)](#文件创建逻辑-file_creatorpy)
6. [配置系统 (config.py)](#配置系统-configpy)

---

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        main.py                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 系统托盘     │  │ 快捷键监听   │  │ 应用生命周期管理      │  │
│  │ (pystray)   │  │ (keyboard)  │  │ (QuickFileCreator)  │  │
│  └─────────────┘  └──────┬──────┘  └─────────────────────┘  │
└──────────────────────────┼──────────────────────────────────┘
                           │ 快捷键触发
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                          ui.py                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 输入框窗口   │  │ 事件处理     │  │ 焦点管理             │  │
│  │ (tkinter)   │  │ (Enter/Esc) │  │ (Windows API)       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │ 错误提示     │  │ 鼠标定位     │                           │
│  │ (红色弹窗)   │  │ (pyautogui) │                           │
│  └─────────────┘  └─────────────┘                           │
└──────────────────────────┬──────────────────────────────────┘
                           │ 创建请求
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    file_creator.py                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 类型判断     │  │ 名称验证     │  │ 文件/文件夹创建       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │ 需要路径
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                       explorer.py                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 窗口枚举     │  │ COM 接口    │  │ 路径解析             │  │
│  │ (win32gui)  │  │ (Shell.App) │  │ (urllib)            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 主程序 (main.py)

### 模块职责

主程序模块负责应用程序的启动、系统托盘管理和全局快捷键监听。

### 托盘图标创建

`create_tray_icon_image()` 函数使用 Pillow 库绘制托盘图标：

```
图标设计（64x64 像素）：
┌────────────────────┐
│  ┌──────────────┐  │  蓝色圆角矩形背景 (#0078d4)
│  │ ──────────── │  │  白色横线表示文件内容
│  │              │  │
│  │ ──────────── │  │
│  └──────────────┘  │
└────────────────────┘
```

### QuickFileCreator 类

应用程序主类，管理整个生命周期：

| 属性 | 类型 | 说明 |
|------|------|------|
| `running` | bool | 应用程序运行状态标志 |
| `window_thread` | Thread | 输入窗口线程引用 |
| `tray_icon` | pystray.Icon | 托盘图标对象 |

### 快捷键处理流程

```
用户按下 Ctrl+Alt+N
        │
        ▼
┌───────────────────┐
│ on_hotkey() 被调用 │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐    是     ┌─────────────┐
│ 窗口线程是否运行？  │─────────▶│ 不创建新窗口 │
└────────┬──────────┘          └─────────────┘
         │ 否
         ▼
┌───────────────────┐
│ 创建守护线程       │
│ 运行输入窗口       │
└───────────────────┘
```

### 托盘菜单结构

```
右键菜单
├── 快捷键: ctrl+alt+n  (禁用状态，仅展示)
├── ─────────────────  (分隔线)
└── 退出               (点击调用 on_exit)
```

---

## 用户界面 (ui.py)

### 模块职责

创建极简输入框窗口，处理用户输入，管理窗口焦点，显示错误提示。

### 窗口特性

| 特性 | 实现方式 | 说明 |
|------|----------|------|
| 无边框 | `overrideredirect(True)` | 移除标题栏和边框 |
| 置顶 | `attributes('-topmost', True)` | 始终显示在最前 |
| 工具窗口 | `attributes('-toolwindow', True)` | 不在任务栏显示 |
| 鼠标位置定位 | `pyautogui.position()` | 在鼠标位置显示 |

### 窗口布局

#### 正常状态

```
┌──────────────────────────────────────────┐
│  ┌────────────────────────────────────┐  │
│  │ 输入文件名（带后缀创建文件...）       │  │  ← 输入框
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
        ↑ 窗口背景 #2d2d2d
                ↑ 输入框背景 #3d3d3d
```

#### 错误状态

```
┌──────────────────────────────────────────┐
│  'test.txt' 已存在                       │  ← 红色错误提示 (#c42b1c)
├──────────────────────────────────────────┤
│  ┌────────────────────────────────────┐  │
│  │ test.txt                           │  │  ← 输入框（保持焦点）
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
```

### 鼠标位置定位

窗口在鼠标指针位置显示，提供更好的用户体验：

```
获取鼠标位置 (pyautogui.position())
        │
        ▼
┌───────────────────┐
│ 窗口是否超出屏幕？  │
└────────┬──────────┘
         │
    ┌────┴────┐
    │         │
   是         否
    │         │
    ▼         ▼
调整位置    直接使用
到边界内    鼠标位置
```

### 事件处理

| 事件 | 处理函数 | 行为 |
|------|----------|------|
| `<FocusIn>` | `_on_focus_in()` | 清除占位符文本 |
| `<FocusOut>` | `_on_focus_out()` | 恢复占位符文本 |
| `<Return>` | `_on_enter()` | 创建文件/文件夹 |
| `<Escape>` | `_on_escape()` | 取消并关闭窗口 |

### 创建流程

```
用户按下 Enter
        │
        ▼
┌───────────────────┐    是     ┌─────────────────────┐
│ 输入为空？         │─────────▶│ 显示错误：名称不能为空│
└────────┬──────────┘          └─────────────────────┘
         │ 否
         ▼
┌───────────────────┐    是     ┌─────────────────────┐
│ 名称非法？         │─────────▶│ 显示错误：非法字符   │
└────────┬──────────┘          └─────────────────────┘
         │ 否
         ▼
┌───────────────────┐    否     ┌─────────────────────┐
│ 创建成功？         │─────────▶│ 显示错误：具体原因   │
└────────┬──────────┘          └─────────────────────┘
         │ 是
         ▼
┌───────────────────┐
│ 关闭窗口           │
└───────────────────┘
```

### 错误提示机制

| 场景 | 错误消息 | 窗口行为 |
|------|----------|----------|
| 输入为空 | "名称不能为空" | 不关闭，显示提示 |
| 名称非法 | "名称包含非法字符: x" | 不关闭，显示提示 |
| 名称已存在 | "'xxx' 已存在" | 不关闭，显示提示 |
| 无权限 | "没有权限在当前位置创建" | 不关闭，显示提示 |
| 创建成功 | - | 自动关闭 |

错误提示特性：
- 红色背景 (#c42b1c)
- 白色文字
- 显示在输入框上方
- 3 秒后自动隐藏
- 输入框保持焦点并全选文本

### 焦点获取机制

无边框窗口默认无法获取焦点，需要使用多重方法：

```
1. Windows API
   ├── SetForegroundWindow(hwnd)  // 设置前台窗口
   ├── ShowWindow(hwnd, 9)        // SW_RESTORE 恢复显示
   └── SetFocus(hwnd)             // 设置焦点

2. 模拟点击
   └── pyautogui.click(x, y)      // 点击窗口区域激活

3. tkinter 方法
   ├── deiconify()                // 显示窗口
   ├── lift()                     // 提升层级
   ├── focus_force()              // 强制焦点
   └── entry.focus_set()          // 输入框获取焦点
```

---

## 资源管理器路径获取 (explorer.py)

### 模块职责

检测资源管理器窗口，获取当前显示的路径。

### 技术原理

#### COM 接口

```
pythoncom.CoInitialize()
        │
        ▼
Shell.Application (COM 对象)
        │
        ├── .Windows() ──▶ 返回所有资源管理器窗口集合
        │
        └── 每个窗口对象
            ├── .HWND        // 窗口句柄
            └── .LocationURL // 当前路径 URL
```

#### 窗口类名

| 类名 | 说明 |
|------|------|
| `CabinetWClass` | Windows 7+ 资源管理器窗口 |
| `ExploreWClass` | 旧版资源管理器窗口 |

#### 路径获取流程

```
获取前台窗口句柄
        │
        ▼
获取进程路径 (GetModuleFileNameEx)
        │
        ▼
┌───────────────────┐    是    ┌─────────────────────┐
│ 是 explorer.exe？ │─────────▶│ 匹配 HWND 获取路径   │
└────────┬──────────┘          └─────────────────────┘
         │ 否
         ▼
┌───────────────────┐
│ 遍历所有资源管理器  │
│ 窗口获取第一个路径  │
└───────────────────┘
```

#### URL 解析

LocationURL 格式：`file:///C:/Users/Admin/Desktop/test`

解析步骤：
1. 移除 `file:///` 前缀
2. URL 解码 (`urllib.parse.unquote`)
3. 转换路径分隔符 `/` → `\`

---

## 文件创建逻辑 (file_creator.py)

### 模块职责

判断创建类型、验证名称合法性、执行创建操作。

### 类型判断规则

`has_extension(name)` 判断逻辑：

```
名称中包含 '.' ?
    │
    ├── 否 ──▶ 创建文件夹
    │
    └── 是
        │
        ├── 以 '.' 开头? (如 .gitignore)
        │       │
        │       └── 是 ──▶ 创建文件夹（隐藏文件视为无扩展名）
        │
        └── 以 '.' 结尾? (如 file.)
                │
                └── 是 ──▶ 创建文件夹
                │
                └── 否 ──▶ 创建文件
```

### 示例

| 输入 | 判断结果 | 操作 |
|------|----------|------|
| `test.txt` | 有扩展名 | 创建文件 |
| `folder` | 无扩展名 | 创建文件夹 |
| `.gitignore` | 隐藏文件 | 创建文件夹 |
| `file.` | 无效扩展名 | 创建文件夹 |

### Windows 文件名非法字符

```
< > : " / \ | ? *
```

| 字符 | 说明 |
|------|------|
| `< >` | 重定向符号 |
| `:` | 驱动器号分隔符 |
| `"` | 引号 |
| `/ \` | 路径分隔符 |
| `|` | 管道符 |
| `? *` | 通配符 |

---

## 配置系统 (config.py)

### 配置项说明

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `HOTKEY` | `ctrl+alt+n` | 全局快捷键 |
| `WINDOW_WIDTH` | `400` | 窗口宽度（像素） |
| `WINDOW_HEIGHT` | `50` | 窗口高度（像素） |
| `WINDOW_BG_COLOR` | `#2d2d2d` | 窗口背景色 |
| `ENTRY_BG_COLOR` | `#3d3d3d` | 输入框背景色 |
| `ENTRY_FG_COLOR` | `#ffffff` | 输入框文字颜色 |
| `ENTRY_FONT` | `('Microsoft YaHei UI', 12)` | 输入框字体 |
| `PLACEHOLDER_TEXT` | `输入文件名...` | 占位符文本 |
| `PLACEHOLDER_COLOR` | `#888888` | 占位符颜色 |

### 快捷键格式

支持格式：
- `ctrl+alt+n`
- `ctrl+shift+n`
- `f12`
- `ctrl+f1`

---

## 依赖库说明

| 库 | 用途 |
|----|------|
| `keyboard` | 全局快捷键监听 |
| `pystray` | 系统托盘图标 |
| `Pillow` | 图标绘制 |
| `pywin32` | Windows API 调用 |
| `pythoncom` | COM 接口支持 |
| `pyautogui` | 鼠标位置获取、模拟点击 |
| `pygetwindow` | 窗口管理 |
| `tkinter` | GUI 界面（内置） |
